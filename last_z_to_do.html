<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LastZ To-Do List for the RAVENs</title>
  <style>
    :root {
      --bg: #0b0f14; --panel:#121826; --muted:#9aa4b2; --text:#e7edf5;
      --accent:#79c0ff; --ok-2:#34d399; --yellow:#facc15; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
      /* Rank Colors */
      --rankS:#ef4444; /* red */
      --rankA:#f59e0b; /* amber */
      --rankB:#10b981; /* emerald */
      --rankC:#3b82f6; /* blue */
      --rankD:#9aa4b2; /* muted */
    }
    html, body {
      margin:0; display:flex; justify-content:center; align-items:center; flex-direction:column; min-height:100vh;
      color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;
      background: var(--bg);
      position: relative;
    }
    body::before {
      content: "";
      position: fixed; inset: 0; z-index: 0;
      background: radial-gradient(1200px 800px at 10% 0%, #0d1320, #080b12 60%);
      pointer-events: none;
    }
    body { background: radial-gradient(1200px 800px at 10% 0%, #0d1320, #080b12 60%), var(--bg); background-attachment: fixed; }
    .container { max-width:820px; width:100%; padding:24px 16px; position: relative; z-index: 1; }
    header { text-align:center; margin-bottom:16px; color: var(--text) !important; }
    .title { font-size:clamp(22px,2.6vw,34px); font-weight:800; display:inline-flex; align-items:center; gap:12px; text-shadow:0 1px 2px rgba(0,0,0,.6); }

    /* â˜… ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é¢¨ ç‚¹æ»…ãƒ©ãƒ³ãƒ— */
    .title .dot {
      width:10px;
      height:10px;
      border-radius:50%;
      background:var(--ok-2);
      box-shadow:0 0 16px 6px rgba(52,211,153,.35);
      animation: dotBlink 1.2s ease-in-out infinite;
    }
    @keyframes dotBlink {
      0% {
        opacity: 0.2;
        transform: scale(0.85);
        box-shadow:0 0 4px 0 rgba(52,211,153,.15);
      }
      50% {
        opacity: 1;
        transform: scale(1);
        box-shadow:0 0 16px 6px rgba(52,211,153,.45);
      }
      100% {
        opacity: 0.2;
        transform: scale(0.85);
        box-shadow:0 0 4px 0 rgba(52,211,153,.15);
      }
    }

    .clock { font-variant-numeric: tabular-nums; color:var(--muted); font-size:14px; margin-top:6px; }
    .panel { background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.0)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; }
    .section { padding:16px; border:1px solid rgba(255,255,255,.06); border-radius:14px; background:rgba(255,255,255,.02); margin-bottom:16px; }
    .section h2 { margin:0 0 10px; font-size:18px; display:flex; align-items:center; gap:10px; }
    .badge { font-size:12px; color:#0b1220; background:var(--accent); padding:2px 8px; border-radius:999px; }
    .badge.outline { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
    .list { display:grid; gap:8px; }
    .item { position:relative; display:grid; grid-template-columns:28px 1fr auto; align-items:center; gap:10px; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:12px; background:rgba(255,255,255,.03); overflow:hidden; }
    .item.ro { grid-template-columns:1fr auto; }
    .item.now { box-shadow: 0 0 0 2px rgba(250,204,21,.15) inset; }
    .item.future { }
    .item.clickable{ cursor:pointer; }
    .muted { color: var(--muted); font-size:12px; }
    .subs { margin:6px 0 0 0; padding-left:18px; color:var(--muted); font-size:12px; }
    .subs li { margin:2px 0; }

    /* ãƒ¡ã‚¤ãƒ³é …ç›®ã‚¢ã‚¤ã‚³ãƒ³ */
    .item-icon { display:inline-flex; align-items:center; justify-content:center; width:30px; height:30px; margin-right:6px; font-size:18px; }

    /* ã‚µãƒ–é …ç›®ã‚¢ã‚¤ã‚³ãƒ³ */
    .sub-icon { display:inline-block; width:1.4em; text-align:center; margin-right:4px; font-size:14px; }

    /* Rank badge */
    .rank-badge { font-weight:700; font-size:11px; letter-spacing:.5px; padding:2px 6px; border-radius:999px; border:1px solid currentColor; display:inline-block; min-width:24px; text-align:center; }
    .rank-S .rank-badge { color:var(--rankS); }
    .rank-A .rank-badge { color:var(--rankA); }
    .rank-B .rank-badge { color:var(--rankB); }
    .rank-C .rank-badge { color:var(--rankC); }
    .rank-D .rank-badge { color:var(--rankD); }

    /* Rank accent on item */
    .item::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; opacity:.9; }
    .rank-S.item { border-color: rgba(239,68,68,.6); }
    .rank-S.item::before { background:var(--rankS); }
    .rank-A.item { border-color: rgba(245,158,11,.5); }
    .rank-A.item::before { background:var(--rankA); }
    .rank-B.item { border-color: rgba(16,185,129,.45); }
    .rank-B.item::before { background:var(--rankB); }
    .rank-C.item { border-color: rgba(59,130,246,.45); }
    .rank-C.item::before { background:var(--rankC); }
    .rank-D.item { border-color: rgba(154,164,178,.45); }
    .rank-D.item::before { background:var(--rankD); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="title"><span class="dot"></span> LastZ To-Do List for the RAVENs</h1>
      <div class="clock" id="clock">--:--</div>
      <div style="margin-top:6px;"><button id="reloadBtn" class="small">ğŸ” ä»Šæ—¥ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å†æŠ•å…¥ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button></div>
    </header>

    <div class="panel">
      <div class="section">
        <h2>ğŸ• ä»Šã‚„ã‚‹ã¹ãã“ã¨ <span class="badge outline" id="now-count">0</span></h2>
        <div id="now-list" class="list"></div>
      </div>

      <div class="section">
        <h2>ğŸ“… ä»Šæ—¥ã‚„ã‚‹ã¹ãã“ã¨ <span class="badge outline" id="today-count">0</span></h2>
        <div id="today-list" class="list"></div>
      </div>

      <div class="section">
        <h2>â³ ã“ã‚Œã‹ã‚‰ã‚„ã‚‹ã“ã¨ <span class="badge outline" id="upcoming-count">0</span></h2>
        <div id="upcoming-list" class="list"></div>
      </div>

      <div class="section">
        <h2>âœ… å®Œäº†æ¸ˆã¿ <span class="badge outline" id="done-count">0</span></h2>
        <div id="done-list" class="list"></div>
      </div>

      <div class="section">
        <h2>ğŸ—“ æ˜æ—¥ã®äºˆå®š <span class="badge outline" id="tomorrow-count">0</span></h2>
        <div id="tomorrow-list" class="list"></div>
      </div>
    </div>
  </div>

  <script>
    // ==== åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====
    const STORAGE_KEY = 'loginless_todo_v1';
    const PRESET_KEY  = 'loginless_todo_preset_date';
    const OFFSET_HOURS = -11; // çµ‚æœ«(AP) = æ—¥æœ¬æ™‚é–“ -11hï¼ˆãƒ­ã‚¸ãƒƒã‚¯ã¯APåŸºæº–ï¼‰
    const ZOMBIE_BASE_KEY = 'loginless_todo_zombie_base_day'; // ã‚¾ãƒ³ãƒ“æš´å›ã®åŸºæº–æ—¥ï¼ˆAPæ—¥ä»˜ã®é€šã—æ—¥ï¼‰

    const fmtDate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const fmtTime = d => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

    const apNow = () => new Date(Date.now() + OFFSET_HOURS*3600*1000);
    const toDateTime = (date,time) => { const [y,m,d]=date.split('-').map(Number); const [hh,mm]=time.split(':').map(Number); return new Date(y,m-1,d,hh,mm,0,0); };

    function getStartEnd(t){
      const s = toDateTime(t.date, t.start || '00:00');
      let e   = new Date(toDateTime(t.date, t.end || '23:59').getTime()+59000); // åˆ†ã®å¢ƒç•Œæ¼ã‚Œé˜²æ­¢
      if(e <= s) e = new Date(e.getTime()+86400000); // æ—¥è·¨ãè£œæ­£
      return {s,e};
    }

    // APæ—¥ä»˜(00:00)åŸºæº–ã®é€šã—æ—¥ï¼ˆ1970/1/1ã‹ã‚‰ã®æ—¥æ•°ï¼‰
    const apDayIndex = (dateStr) => Math.floor(toDateTime(dateStr,'00:00').getTime()/86400000);

    let tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    // === æ ã”ã¨ã®ã‚µãƒ–ã‚¿ã‚¹ã‚¯å®šç¾©ï¼ˆAPæ™‚é–“ã®ä»£ã‚ã‚Šã«è¡¨ç¤ºï¼‰ ===
    const SUBTASKS = {
      'é¿é›£æ‰€å»ºè¨­': ['å»ºç¯‰æˆ¦åŠ›ã‚’ä¸Šã’ã‚‹','å»ºç¯‰åŠ é€Ÿã‚’ä½¿ã†'],
      'æŠ€è¡“ç ”ç©¶': ['ç ”ç©¶æˆ¦åŠ›ã‚’ä¸Šã’ã‚‹','ç ”ç©¶åŠ é€Ÿã‚’ä½¿ã†'],
      'æ”¹é€ è»Šå¼·åŒ–': ['æ”¹é€ å›³ã‚’æ¶ˆè²»ã™ã‚‹','ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ¬ãƒ³ãƒã‚’æ¶ˆè²»ã™ã‚‹','ã‚¸ãƒ£ãƒ³ãƒœã‚¾ãƒ³ãƒ“ã‚’å€’ã™','ã‚¾ãƒ³ãƒ“ã‚’å€’ã™'],
      'ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ': ['é«˜ç´šå‹Ÿé›†ã‚’è¡Œã†','çµŒé¨“å€¤ã‚’æ¶ˆè²»ã™ã‚‹'],
      'è»éšŠæ‹¡å¼µ': ['è¨“ç·´åŠ é€Ÿã‚’ä½¿ã†','è¨“ç·´ã—ã¦å…µå£«ã‚’å—ã‘å–ã‚‹','å…µå£«ã‚’æ˜‡æ ¼ã™ã‚‹'],
      'å‡¶æš´é¦–é ˜ï¼ˆè¡€ã®ãƒãƒ©ï¼‰': ['1æ—¥4å›æ”»æ’ƒã™ã‚‹','ã‚½ãƒ•ã‚£ã‚¢ãƒ»ã‚«ãƒˆãƒªãƒ¼ãƒŠãƒ»ã‚ªãƒªãƒ™ã‚¤ãƒ©ãƒ»ã‚»ãƒªãƒ¼ãƒ³ã‚’ãƒ¡ã‚¤ãƒ³ã«ã™ã‚‹'],
      'å‡¶æš´é¦–é ˜ï¼ˆæšã®ç¿¼ï¼‰': ['1æ—¥4å›æ”»æ’ƒã™ã‚‹','ãƒ­ãƒ¼ãƒ©ãƒ»ã‚¨ãƒŸãƒªã‚¢ãƒ»ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ»ãƒ‹ã‚³ã‚¹ã‚’ãƒ¡ã‚¤ãƒ³ã«ã™ã‚‹'],
      'å‡¶æš´é¦–é ˜ï¼ˆè‡ªç”±æ„å¿—ï¼‰': ['1æ—¥4å›æ”»æ’ƒã™ã‚‹','ãƒŸã‚¢ãƒ»åƒå¤ãƒ»ã‚¨ãƒ–ãƒªãƒ³ãƒ»æ¡œã‚’ãƒ¡ã‚¤ãƒ³ã«ã™ã‚‹'],
      'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›': ['å‚åŠ ã—ãªã„å ´åˆã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‚åŠ ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ãªã„','é›†çµåºƒå ´ãƒ¬ãƒ™ãƒ«20ä»¥ä¸Šã®äººã®ã¿é›†çµã‚’ç™ºèµ·ã™ã‚‹'],
      'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›': ['å‚åŠ ã—ãªã„å ´åˆã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‚åŠ ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ãªã„'],
      'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆæº–å‚™ï¼‰': ['éƒ¨éšŠã‚’é–‹å§‹æ™‚é–“ã¾ã§ã«æœ¬éƒ¨ã«æ ¼ç´ã™ã‚‹'],
      'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆæº–å‚™ï¼‰': ['éƒ¨éšŠã‚’é–‹å§‹æ™‚é–“ã¾ã§ã«æœ¬éƒ¨ã«æ ¼ç´ã™ã‚‹'],
      'å³¡è°·äº‰å¥ªæˆ¦ï¼ˆå‡ºæ¬ ç¢ºèªï¼‰': ['é‡‘æ›œæ—¥20æ™‚ã‹ã‚‰ã®å³¡è°·äº‰å¥ªæˆ¦ã«å‚åŠ å¯å¦ã‚’é¸ã‚“ã§ãã ã•ã„','æ—©ã‚ã®é¸æŠã‚’ãŠé¡˜ã„ã—ã¾ã™'],
      'å³¡è°·äº‰å¥ªæˆ¦ï¼ˆæº–å‚™ï¼‰': ['éƒ¨éšŠã‚’é–‹å§‹æ™‚é–“ã¾ã§ã«æœ¬éƒ¨ã«æ ¼ç´ã™ã‚‹','ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ³ãƒãƒ¼ã¯é–‹å§‹5åˆ†å‰ã«å…¥å ´å¯èƒ½','ã‚µãƒ–ãƒ¡ãƒ³ãƒãƒ¼ã‚‚å¾…æ©Ÿã—ã¦ãŠã'],
      'æ•µè»æ’ƒç ´ï¼ˆã‚­ãƒ«ãƒ‡ãƒ¼ï¼‰': ['åŸºæœ¬çš„ã«å¿…ãšã‚·ãƒ¼ãƒ«ãƒ‰ã‚’ã™ã‚‹','å¯¾æˆ¦ç›¸æ‰‹ã¯282R','Lv.6éƒ½å¸‚å†…ã®ç•¥å¥ªã¯ç¦æ­¢','Lv.6éƒ½å¸‚å¤–ã®ç•¥å¥ªã¯OK','282ã‚’é˜²è¡›ã™ã‚‹ä¾µç•¥è¿æ’ƒã‚‚OK','282Rã¨ã®TvTã‚’å®Ÿæ–½äºˆå®š','282å†…ã§ç•¥å¥ªã™ã‚‹ã¨å¼·æ•µã«è¿æ’ƒã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Š'],
      'é»„è‰²ã„ãƒãƒ©ã‚’è´ˆã‚‹': ['5æœ¬èª°ã‹ã«è´ˆã‚‹','ç ”ç©¶åŠ é€Ÿ20%UP','2æ™‚é–“åŠ¹æœç¶™ç¶š','æœˆæ›œæ—¥ã«åŠ¹æœã¨æœ¬æ•°ãŒå¤‰ã‚ã‚‹','é€±è·¨ãã®åŠ¹æœã¯ä¸Šæ›¸ãã•ã‚Œç›¸ä¹—ã—ãªã„']
    };

    // ãƒ¡ã‚¤ãƒ³é …ç›®ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©ï¼ˆã‚¿ã‚¤ãƒˆãƒ«â†’çµµæ–‡å­—ï¼‰
    // ãƒ¡ã‚¤ãƒ³é …ç›®ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©ï¼ˆã‚¿ã‚¤ãƒˆãƒ«â†’çµµæ–‡å­—ï¼‰
    const ICON_BY_TITLE = {
      // æ—¢å­˜ãƒ¡ã‚¤ãƒ³æ 
      'é¿é›£æ‰€å»ºè¨­':'ğŸ•ï¸',
      'æŠ€è¡“ç ”ç©¶':'ğŸ§ª',
      'æ”¹é€ è»Šå¼·åŒ–':'ğŸš™',
      'ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ':'ğŸ¦¸',
      'è»éšŠæ‹¡å¼µ':'ğŸ›¡ï¸',

      // ãƒ¬ãƒ¼ãƒ€ãƒ¼/æ—¥èª²ç³»
      'ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å—é ˜':'ğŸ“¡',
      'ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³Sãƒ©ãƒ³ã‚¯å³é¸':'ğŸ…',
      'ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è²¯è“„':'ğŸ’¾',
      'éƒ¨å“ç®±ã‚’æ¶ˆè²»':'ğŸ§°',

      // æ¶ˆè²»ãƒ»åŠ é€Ÿç³»ï¼ˆALLDAY_PRESETï¼‰
      'æ”¹é€ å›³ã‚’æ¶ˆè²»ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰':'ğŸ“œ',
      'ãƒ¬ãƒ³ãƒã‚’æ¶ˆè²»ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰':'ğŸ”§',
      'é¿é›£è€…ã‚’å‹Ÿé›†ï¼ˆé’ãƒ»ç´«ãƒ»æ©™ï¼‰':'ğŸ§â€â™‚ï¸',
      'æ‡¸è³ä»»å‹™ã‚’å®Ÿæ–½ï¼ˆæ©™ï¼‰':'ğŸ¯',
      'å»ºç¯‰åŠ é€Ÿã‚’æ¶ˆè²»ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰':'â©',
      'å»ºç¯‰ã‚’å®Œäº†ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰':'ğŸ—ï¸',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å®Ÿæ–½ï¼ˆæ©™ï¼‰':'ğŸšš',
      'ä¿å®‰å®˜ãƒãƒƒã‚¸ã‚’æ¶ˆè²»':'ğŸ–ï¸',
      'ç ”ç©¶åŠ é€Ÿã‚’æ¶ˆè²»ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰':'âš¡',
      'ç ”ç©¶ã‚’å®Œäº†ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰':'ğŸ”¬',

      'ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ¶ˆè²»ï¼ˆé’ãƒ»ç´«ãƒ»æ©™ï¼‰':'ğŸ§©',
      'å°‚ç”¨è£…å‚™æ¬ ç‰‡ã‚’æ¶ˆè²»':'ğŸª–',
      'ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚³ã‚¢ã‚’æ¶ˆè²»':'ğŸ”‹',
      'Sç´šè£…å‚™ã‚’æ¶ˆè²»':'ğŸ›¡ï¸',
      'å¼·åŒ–åˆé‡‘ã‚’æ¶ˆè²»':'ğŸ§±',
      'ã‚¹ã‚­ãƒ«ãƒ–ãƒƒã‚¯ã‚’æ¶ˆè²»ï¼ˆæ©™ï¼‰':'ğŸ“™',
      'é«˜ç´šå‹Ÿé›†ã‚’å®Ÿè¡Œï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰':'ğŸ«',

      'å…¨ã¦ã®åŠ é€Ÿã‚’æ¶ˆè²»':'â©',
      'å»ºç¯‰ã‚’å®Œäº†':'ğŸ—ï¸',
      'ç ”ç©¶ã‚’å®Œäº†':'ğŸ”¬',
      'å…µå£«ã‚’æ˜‡æ ¼ãƒ»å—é ˜ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰':'ğŸ¥‡',
      'æ•µã‚’å€’ã™':'âš”ï¸',

      // ãƒœã‚¹ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ
      'å‡¶æš´é¦–é ˜ï¼ˆè¡€ã®ãƒãƒ©ï¼‰':'ğŸŒ¹',
      'å‡¶æš´é¦–é ˜ï¼ˆæšã®ç¿¼ï¼‰':'ğŸŒ…',
      'å‡¶æš´é¦–é ˜ï¼ˆè‡ªç”±æ„å¿—ï¼‰':'ğŸ•Šï¸',
      'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›':'ğŸ§Ÿ',
      'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›':'ğŸ§Ÿâ€â™€ï¸',
      'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆæº–å‚™ï¼‰':'â±ï¸',
      'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆæº–å‚™ï¼‰':'â±ï¸',
      'è©¦ç·´ã‚¾ãƒ³ãƒ“':'ğŸ§Ÿ',
      'æ•µè»æ’ƒç ´ï¼ˆã‚­ãƒ«ãƒ‡ãƒ¼ï¼‰':'âš”ï¸',

      'å³¡è°·äº‰å¥ªæˆ¦':'ğŸï¸',
      'å³¡è°·äº‰å¥ªæˆ¦ï¼ˆæº–å‚™ï¼‰':'âš™ï¸',
      'å³¡è°·äº‰å¥ªæˆ¦ï¼ˆå‡ºæ¬ ç¢ºèªï¼‰':'ğŸ“£',

      // ãƒ‡ã‚¤ãƒªãƒ¼å ±é…¬ç³»
      'VIPç‰¹å…¸ã‚’å—é ˜':'ğŸ–ï¸',
      'æ¯æ—¥ç‰¹å…¸ã‚’å—é ˜':'ğŸ',
      'ãŠè²·ã„å¾—ãªè£œçµ¦ã‚’å—é ˜':'ğŸ“¦',
      'é¿é›£æ•‘åŠ©æœˆã‚«ãƒ¼ãƒ‰ã‚’å—é ˜ï¼ˆèª²é‡‘è€…ã®ã¿ï¼‰':'ğŸ’³',

      // é—‡å¸‚ãƒ»ã‚·ãƒ§ãƒƒãƒ—
      'é—‡å¸‚ã§è²·ã„ç‰©ï¼ˆæ›´æ–°ï¼‰ã‚’å®Œäº†':'ğŸ›’',
      'é—‡å¸‚ã§è³‡æºãƒœãƒƒã‚¯ã‚¹ã‚’å—é ˜':'ğŸ“¦',

      // PvP / ã‚¢ãƒªãƒ¼ãƒŠ
      'é ‚ä¸Šç«¶æŠ€å ´ï¼ˆã‚¢ãƒªãƒ¼ãƒŠï¼‰ã§æˆ¦ã†':'ğŸŸï¸',

      // ç‡ƒæ–™ãƒ»å›³é¢
      'ç„¡æ–™ç‡ƒæ–™ã‚’100å—ã‘å–ã‚‹':'â›½',
      'ã‚«ãƒˆãƒªãƒ¼ãƒŠã®ç‡ƒæ–™100ã‚’å—ã‘å–ã‚‹':'â›½',
      'ãƒŸã‚¢æ”¹é€ å›³ã‚’å—ã‘å–ã‚‹':'ğŸ“œ',

      // å±æ©Ÿä¸€é«ª ç³»
      'å±æ©Ÿä¸€é«ª è‡ªå‹•ãƒãƒ¼ãƒ çµæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™':'ğŸ”˜',
      'å±æ©Ÿä¸€é«ª é›†çµã‚’ç™ºèµ·ã™ã‚‹ 1å›ç›®':'ğŸ“£',
      'å±æ©Ÿä¸€é«ª é›†çµã‚’ç™ºèµ·ã™ã‚‹ 2å›ç›®':'ğŸ“£',
      'å±æ©Ÿä¸€é«ª é›†çµã‚’ç™ºèµ·ã™ã‚‹ 3å›ç›®':'ğŸ“£',
      'å±æ©Ÿä¸€é«ª é›†çµã‚’ç™ºèµ·ã™ã‚‹ 4å›ç›®':'ğŸ“£',
      'å±æ©Ÿä¸€é«ª é›†çµã‚’ç™ºèµ·ã™ã‚‹ 5å›ç›®':'ğŸ“£',

      // éƒ½å¸‚é–“è²¿æ˜“ï¼šå‡ºç™º
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å‡ºç™º 1å›ç›®':'icons/éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯.png',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å‡ºç™º 2å›ç›®':'icons/éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯.png',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å‡ºç™º 3å›ç›®':'icons/éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯.png',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å‡ºç™º 4å›ç›®':'icons/éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯.png',

      // éƒ½å¸‚é–“è²¿æ˜“ï¼šç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ï¼‰
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰ 1å›ç›®':'ğŸš›ğŸ’¥',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰ 2å›ç›®':'ğŸš›ğŸ’¥',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰ 3å›ç›®':'ğŸš›ğŸ’¥',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰ 4å›ç›®':'ğŸš›ğŸ’¥',

      // æ‡¸è³ä»»å‹™ï¼šç•¥å¥ªãƒ»å”åŠ›
      'ä»–äººã®æ‡¸è³ä»»å‹™ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰1å›ç›®':'ğŸ´â€â˜ ï¸',
      'ä»–äººã®æ‡¸è³ä»»å‹™ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰2å›ç›®':'ğŸ´â€â˜ ï¸',
      'ä»–äººã®æ‡¸è³ä»»å‹™ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰3å›ç›®':'ğŸ´â€â˜ ï¸',
      'ä»–äººã®æ‡¸è³ä»»å‹™ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰4å›ç›®':'ğŸ´â€â˜ ï¸',
      'ä»–äººã®æ‡¸è³ä»»å‹™ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰5å›ç›®':'ğŸ´â€â˜ ï¸',

      'ç›Ÿå‹ã®æ‡¸è³ä»»å‹™ã‚’å”åŠ› 1å›ç›®':'ğŸ¤',
      'ç›Ÿå‹ã®æ‡¸è³ä»»å‹™ã‚’å”åŠ› 2å›ç›®':'ğŸ¤',
      'ç›Ÿå‹ã®æ‡¸è³ä»»å‹™ã‚’å”åŠ› 3å›ç›®':'ğŸ¤',
      'ç›Ÿå‹ã®æ‡¸è³ä»»å‹™ã‚’å”åŠ› 4å›ç›®':'ğŸ¤',
      'ç›Ÿå‹ã®æ‡¸è³ä»»å‹™ã‚’å”åŠ› 5å›ç›®':'ğŸ¤',

      'æ‡¸è³ä»»å‹™ã‚’å®Ÿè¡Œ':'ğŸ¯',

      // èª²é‡‘
      'ãŠå¾—ãªå®ç‰©160å††èª²é‡‘':'ğŸ’',

      // ãã®ä»–ãƒ‡ã‚¤ãƒªãƒ¼
      'é»„è‰²ã„ãƒãƒ©ã‚’è´ˆã‚‹':'ğŸŒ¼'
    };


    // ã‚µãƒ–é …ç›®ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©ï¼ˆãƒ†ã‚­ã‚¹ãƒˆâ†’çµµæ–‡å­—ï¼‰
    const SUB_ICON_BY_TEXT = {
      'å»ºç¯‰æˆ¦åŠ›ã‚’ä¸Šã’ã‚‹':'ğŸ—ï¸',
      'å»ºç¯‰åŠ é€Ÿã‚’ä½¿ã†':'â©',
      'ç ”ç©¶æˆ¦åŠ›ã‚’ä¸Šã’ã‚‹':'ğŸ“š',
      'ç ”ç©¶åŠ é€Ÿã‚’ä½¿ã†':'â©',
      'æ”¹é€ å›³ã‚’æ¶ˆè²»ã™ã‚‹':'ğŸ“œ',
      'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ¬ãƒ³ãƒã‚’æ¶ˆè²»ã™ã‚‹':'ğŸ”§',
      'ã‚¸ãƒ£ãƒ³ãƒœã‚¾ãƒ³ãƒ“ã‚’å€’ã™':'ğŸ§Ÿâ€â™‚ï¸',
      'ã‚¾ãƒ³ãƒ“ã‚’å€’ã™':'âš”ï¸',
      'é«˜ç´šå‹Ÿé›†ã‚’è¡Œã†':'ğŸ«',
      'çµŒé¨“å€¤ã‚’æ¶ˆè²»ã™ã‚‹':'ğŸ“˜',
      'è¨“ç·´åŠ é€Ÿã‚’ä½¿ã†':'â©',
      'è¨“ç·´ã—ã¦å…µå£«ã‚’å—ã‘å–ã‚‹':'ğŸª–',
      'å…µå£«ã‚’æ˜‡æ ¼ã™ã‚‹':'ğŸ”º',
      '1æ—¥4å›æ”»æ’ƒã™ã‚‹':'4ï¸âƒ£',
      'ã‚½ãƒ•ã‚£ã‚¢ãƒ»ã‚«ãƒˆãƒªãƒ¼ãƒŠãƒ»ã‚ªãƒªãƒ™ã‚¤ãƒ©ãƒ»ã‚»ãƒªãƒ¼ãƒ³ã‚’ãƒ¡ã‚¤ãƒ³ã«ã™ã‚‹':'ğŸ‘©â€ğŸ“',
      'ãƒ­ãƒ¼ãƒ©ãƒ»ã‚¨ãƒŸãƒªã‚¢ãƒ»ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ»ãƒ‹ã‚³ã‚¹ã‚’ãƒ¡ã‚¤ãƒ³ã«ã™ã‚‹':'ğŸ§‘â€âœˆï¸',
      'ãƒŸã‚¢ãƒ»åƒå¤ãƒ»ã‚¨ãƒ–ãƒªãƒ³ãƒ»æ¡œã‚’ãƒ¡ã‚¤ãƒ³ã«ã™ã‚‹':'ğŸ‘©â€ğŸš€',
      'å‚åŠ ã—ãªã„å ´åˆã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‚åŠ ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ãªã„':'ğŸš«',
      'é›†çµåºƒå ´ãƒ¬ãƒ™ãƒ«20ä»¥ä¸Šã®äººã®ã¿é›†çµã‚’ç™ºèµ·ã™ã‚‹':'ğŸ°',
      'éƒ¨éšŠã‚’é–‹å§‹æ™‚é–“ã¾ã§ã«æœ¬éƒ¨ã«æ ¼ç´ã™ã‚‹':'ğŸ ',
      'é‡‘æ›œæ—¥20æ™‚ã‹ã‚‰ã®å³¡è°·äº‰å¥ªæˆ¦ã«å‚åŠ å¯å¦ã‚’é¸ã‚“ã§ãã ã•ã„':'âœ…',
      'æ—©ã‚ã®é¸æŠã‚’ãŠé¡˜ã„ã—ã¾ã™':'â°',
      'ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ³ãƒãƒ¼ã¯é–‹å§‹5åˆ†å‰ã«å…¥å ´å¯èƒ½':'â±ï¸',
      'ã‚µãƒ–ãƒ¡ãƒ³ãƒãƒ¼ã‚‚å¾…æ©Ÿã—ã¦ãŠã':'ğŸ§',
      'åŸºæœ¬çš„ã«å¿…ãšã‚·ãƒ¼ãƒ«ãƒ‰ã‚’ã™ã‚‹':'ğŸ›¡ï¸',
      'å¯¾æˆ¦ç›¸æ‰‹ã¯282R':'ğŸ“',
      'Lv.6éƒ½å¸‚å†…ã®ç•¥å¥ªã¯ç¦æ­¢':'ğŸš«',
      'Lv.6éƒ½å¸‚å¤–ã®ç•¥å¥ªã¯OK':'âœ…',
      '282ã‚’é˜²è¡›ã™ã‚‹ä¾µç•¥è¿æ’ƒã‚‚OK':'âš”ï¸',
      '282Rã¨ã®TvTã‚’å®Ÿæ–½äºˆå®š':'ğŸ“º',
      '282å†…ã§ç•¥å¥ªã™ã‚‹ã¨å¼·æ•µã«è¿æ’ƒã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Š':'âš ï¸',
      '5æœ¬èª°ã‹ã«è´ˆã‚‹':'ğŸ’',
      'ç ”ç©¶åŠ é€Ÿ20%UP':'âš¡',
      '2æ™‚é–“åŠ¹æœç¶™ç¶š':'â±ï¸',
      'æœˆæ›œæ—¥ã«åŠ¹æœã¨æœ¬æ•°ãŒå¤‰ã‚ã‚‹':'ğŸ“…',
      'é€±è·¨ãã®åŠ¹æœã¯ä¸Šæ›¸ãã•ã‚Œç›¸ä¹—ã—ãªã„':'ğŸ”'
    };

    function createIconNodeForTask(t){
      const icon = ICON_BY_TITLE[t.title];
      if (!icon) return null;

      const span = document.createElement('span');
      span.className = 'item-icon';

      // ç”»åƒãƒ‘ã‚¹ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆhttp(s) ã¾ãŸã¯ æ‹¡å¼µå­ãŒç”»åƒã£ã½ã„ã‚‚ã®ï¼‰
      const isImagePath =
        /^https?:\/\//.test(icon) ||            // çµ¶å¯¾URL
        /\.(png|jpe?g|gif|webp|svg)$/i.test(icon); // ç›¸å¯¾ãƒ‘ã‚¹OK

      if (isImagePath) {
        const img = document.createElement('img');
        img.src = icon;
        img.alt = '';
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        img.loading = 'lazy';
        span.appendChild(img);
      } else {
        // çµµæ–‡å­—ã‚„ãƒ†ã‚­ã‚¹ãƒˆã¯ãã®ã¾ã¾è¡¨ç¤º
        span.textContent = icon;
      }

      return span;
    }


    // ==== APåŸºæº–ã®é€±æ¬¡ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆ6æ ï¼‰ ====
    const WEEKLY_PRESET = {
      1:[['00:00','03:59','é¿é›£æ‰€å»ºè¨­'],['04:00','07:59','æŠ€è¡“ç ”ç©¶'],['08:00','11:59','æ”¹é€ è»Šå¼·åŒ–'],['12:00','15:59','ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ'],['16:00','19:59','è»éšŠæ‹¡å¼µ'],['20:00','23:59','æ”¹é€ è»Šå¼·åŒ–']],
      2:[['00:00','03:59','æŠ€è¡“ç ”ç©¶'],['04:00','07:59','ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ'],['08:00','11:59','é¿é›£æ‰€å»ºè¨­'],['12:00','15:59','è»éšŠæ‹¡å¼µ'],['16:00','19:59','æ”¹é€ è»Šå¼·åŒ–'],['20:00','23:59','é¿é›£æ‰€å»ºè¨­']],
      3:[['00:00','03:59','ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ'],['04:00','07:59','è»éšŠæ‹¡å¼µ'],['08:00','11:59','æŠ€è¡“ç ”ç©¶'],['12:00','15:59','æ”¹é€ è»Šå¼·åŒ–'],['16:00','19:59','é¿é›£æ‰€å»ºè¨­'],['20:00','23:59','æŠ€è¡“ç ”ç©¶']],
      4:[['00:00','03:59','è»éšŠæ‹¡å¼µ'],['04:00','07:59','æ”¹é€ è»Šå¼·åŒ–'],['08:00','11:59','ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ'],['12:00','15:59','é¿é›£æ‰€å»ºè¨­'],['16:00','19:59','æŠ€è¡“ç ”ç©¶'],['20:00','23:59','ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ']],
      5:[['00:00','03:59','æ”¹é€ è»Šå¼·åŒ–'],['04:00','07:59','é¿é›£æ‰€å»ºè¨­'],['08:00','11:59','è»éšŠæ‹¡å¼µ'],['12:00','15:59','æŠ€è¡“ç ”ç©¶'],['16:00','19:59','ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ'],['20:00','23:59','è»éšŠæ‹¡å¼µ']],
      6:[['00:00','03:59','æŠ€è¡“ç ”ç©¶'],['04:00','07:59','æ”¹é€ è»Šå¼·åŒ–'],['08:00','11:59','ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ'],['12:00','15:59','é¿é›£æ‰€å»ºè¨­'],['16:00','19:59','è»éšŠæ‹¡å¼µ'],['20:00','23:59','ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ']],
      0:[['00:00','03:59','æ”¹é€ è»Šå¼·åŒ–'],['04:00','07:59','é¿é›£æ‰€å»ºè¨­'],['08:00','11:59','è»éšŠæ‹¡å¼µ'],['12:00','15:59','æŠ€è¡“ç ”ç©¶'],['16:00','19:59','ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ'],['20:00','23:59','è»éšŠæ‹¡å¼µ']]
    };

    // æ›œæ—¥åˆ¥ã®çµ‚æ—¥ã‚¿ã‚¹ã‚¯ï¼ˆAPæ—¥ä»˜ã§ä»Šæ—¥ã®ã¿è¡¨ç¤ºï¼‰
    const ALLDAY_PRESET = {
      1: ['ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å—é ˜','éƒ¨å“ç®±ã‚’æ¶ˆè²»','æ”¹é€ å›³ã‚’æ¶ˆè²»ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰','ãƒ¬ãƒ³ãƒã‚’æ¶ˆè²»ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰'],
      2: ['é¿é›£è€…ã‚’å‹Ÿé›†ï¼ˆé’ãƒ»ç´«ãƒ»æ©™ï¼‰','æ‡¸è³ä»»å‹™ã‚’å®Ÿæ–½ï¼ˆæ©™ï¼‰','å»ºç¯‰åŠ é€Ÿã‚’æ¶ˆè²»ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰','å»ºç¯‰ã‚’å®Œäº†ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰'],
      3: ['ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³Sãƒ©ãƒ³ã‚¯å³é¸','éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å®Ÿæ–½ï¼ˆæ©™ï¼‰','ä¿å®‰å®˜ãƒãƒƒã‚¸ã‚’æ¶ˆè²»','ç ”ç©¶åŠ é€Ÿã‚’æ¶ˆè²»ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰','ç ”ç©¶ã‚’å®Œäº†ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰'],
      4: ['ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è²¯è“„','ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ¶ˆè²»ï¼ˆé’ãƒ»ç´«ãƒ»æ©™ï¼‰','å°‚ç”¨è£…å‚™æ¬ ç‰‡ã‚’æ¶ˆè²»','ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚³ã‚¢ã‚’æ¶ˆè²»','Sç´šè£…å‚™ã‚’æ¶ˆè²»','å¼·åŒ–åˆé‡‘ã‚’æ¶ˆè²»','ã‚¹ã‚­ãƒ«ãƒ–ãƒƒã‚¯ã‚’æ¶ˆè²»ï¼ˆæ©™ï¼‰','é«˜ç´šå‹Ÿé›†ã‚’å®Ÿè¡Œï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰'],
      5: ['ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å—é ˜','å…¨ã¦ã®åŠ é€Ÿã‚’æ¶ˆè²»','å»ºç¯‰ã‚’å®Œäº†','ç ”ç©¶ã‚’å®Œäº†','å…µå£«ã‚’æ˜‡æ ¼ãƒ»å—é ˜ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰'],
      6: ['ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³Sãƒ©ãƒ³ã‚¯å³é¸','å…¨ã¦ã®åŠ é€Ÿã‚’æ¶ˆè²»','æ‡¸è³ä»»å‹™ã‚’å®Ÿæ–½ï¼ˆæ©™ï¼‰','éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å®Ÿæ–½ï¼ˆæ©™ï¼‰','æ•µã‚’å€’ã™'],
      0: ['ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è²¯è“„']
    };

    // æ¯æ—¥å…±é€šã®çµ‚æ—¥ã‚¿ã‚¹ã‚¯ï¼ˆæ›œæ—¥ã«é–¢ä¿‚ãªãæ¯æ—¥å…¥ã‚Œã‚‹ï¼‰
    const DAILY_COMMON = [
      'VIPç‰¹å…¸ã‚’å—é ˜',
      'æ¯æ—¥ç‰¹å…¸ã‚’å—é ˜',
      'ãŠè²·ã„å¾—ãªè£œçµ¦ã‚’å—é ˜',
      'é¿é›£æ•‘åŠ©æœˆã‚«ãƒ¼ãƒ‰ã‚’å—é ˜ï¼ˆèª²é‡‘è€…ã®ã¿ï¼‰',
      'é—‡å¸‚ã§è²·ã„ç‰©ï¼ˆæ›´æ–°ï¼‰ã‚’å®Œäº†',
      'é—‡å¸‚ã§è³‡æºãƒœãƒƒã‚¯ã‚¹ã‚’å—é ˜',
      'é ‚ä¸Šç«¶æŠ€å ´ï¼ˆã‚¢ãƒªãƒ¼ãƒŠï¼‰ã§æˆ¦ã†',
      'å±æ©Ÿä¸€é«ª è‡ªå‹•ãƒãƒ¼ãƒ çµæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™',
      'å±æ©Ÿä¸€é«ª é›†çµã‚’ç™ºèµ·ã™ã‚‹ 1å›ç›®',
      'å±æ©Ÿä¸€é«ª é›†çµã‚’ç™ºèµ·ã™ã‚‹ 2å›ç›®',
      'å±æ©Ÿä¸€é«ª é›†çµã‚’ç™ºèµ·ã™ã‚‹ 3å›ç›®',
      'å±æ©Ÿä¸€é«ª é›†çµã‚’ç™ºèµ·ã™ã‚‹ 4å›ç›®',
      'å±æ©Ÿä¸€é«ª é›†çµã‚’ç™ºèµ·ã™ã‚‹ 5å›ç›®',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å‡ºç™º 1å›ç›®',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å‡ºç™º 2å›ç›®',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å‡ºç™º 3å›ç›®',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’å‡ºç™º 4å›ç›®',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰ 1å›ç›®',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰ 2å›ç›®',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰ 3å›ç›®',
      'éƒ½å¸‚é–“è²¿æ˜“ãƒˆãƒ©ãƒƒã‚¯ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰ 4å›ç›®',
      'ä»–äººã®æ‡¸è³ä»»å‹™ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰1å›ç›®',
      'ä»–äººã®æ‡¸è³ä»»å‹™ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰2å›ç›®',
      'ä»–äººã®æ‡¸è³ä»»å‹™ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰3å›ç›®',
      'ä»–äººã®æ‡¸è³ä»»å‹™ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰4å›ç›®',
      'ä»–äººã®æ‡¸è³ä»»å‹™ã‚’ç•¥å¥ªï¼ˆä»–ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹™ã†ï¼‰5å›ç›®',
      'ç›Ÿå‹ã®æ‡¸è³ä»»å‹™ã‚’å”åŠ› 1å›ç›®',
      'ç›Ÿå‹ã®æ‡¸è³ä»»å‹™ã‚’å”åŠ› 2å›ç›®',
      'ç›Ÿå‹ã®æ‡¸è³ä»»å‹™ã‚’å”åŠ› 3å›ç›®',
      'ç›Ÿå‹ã®æ‡¸è³ä»»å‹™ã‚’å”åŠ› 4å›ç›®',
      'ç›Ÿå‹ã®æ‡¸è³ä»»å‹™ã‚’å”åŠ› 5å›ç›®',
      'æ‡¸è³ä»»å‹™ã‚’å®Ÿè¡Œ',
      'ãŠå¾—ãªå®ç‰©160å††èª²é‡‘',
      'ã‚«ãƒˆãƒªãƒ¼ãƒŠã®ç‡ƒæ–™100ã‚’å—ã‘å–ã‚‹',
      'ãƒŸã‚¢æ”¹é€ å›³ã‚’å—ã‘å–ã‚‹',
      'é»„è‰²ã„ãƒãƒ©ã‚’è´ˆã‚‹'
    ];

    // === ãƒ©ãƒ³ã‚¯å®šç¾©ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸€è‡´ã§å‰²ã‚Šå½“ã¦ï¼‰ ===
    const RANK_BY_TITLE = {
      'å³¡è°·äº‰å¥ªæˆ¦':'S',
      'å³¡è°·äº‰å¥ªæˆ¦ï¼ˆæº–å‚™ï¼‰':'A',
      'å³¡è°·äº‰å¥ªæˆ¦ï¼ˆå‡ºæ¬ ç¢ºèªï¼‰':'A',
      'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›':'S',
      'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›':'S',
      'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆæº–å‚™ï¼‰':'A',
      'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆæº–å‚™ï¼‰':'A',
      'å‡¶æš´é¦–é ˜ï¼ˆè¡€ã®ãƒãƒ©ï¼‰':'B',
      'å‡¶æš´é¦–é ˜ï¼ˆæšã®ç¿¼ï¼‰':'B',
      'å‡¶æš´é¦–é ˜ï¼ˆè‡ªç”±æ„å¿—ï¼‰':'B',
      'è©¦ç·´ã‚¾ãƒ³ãƒ“':'B',
      'é»„è‰²ã„ãƒãƒ©ã‚’è´ˆã‚‹':'A',
      'æ•µè»æ’ƒç ´ï¼ˆã‚­ãƒ«ãƒ‡ãƒ¼ï¼‰':'S',
      'é¿é›£æ‰€å»ºè¨­':'B', 'æŠ€è¡“ç ”ç©¶':'B', 'æ”¹é€ è»Šå¼·åŒ–':'B', 'ãƒ’ãƒ¼ãƒ­ãƒ¼è‚²æˆ':'B', 'è»éšŠæ‹¡å¼µ':'B'
    };
    const DEFAULT_RANK = 'C';

    // ã‚¿ã‚¤ãƒˆãƒ«ã«ã€Sã€‘ã‚„[S]ãªã©ã®ã‚¿ã‚°ãŒå…ˆé ­ã«ã‚ã‚‹å ´åˆã¯å„ªå…ˆæ¡ç”¨
    const RANK_TAG_RE = /^\s*(?:[\[ã€]([SABCD])[\]ã€‘])\s*/;
    function parseRankFromTitle(title){
      const m = title.match(RANK_TAG_RE);
      return m ? m[1] : null;
    }
    function stripRankTag(title){
      return title.replace(RANK_TAG_RE, '');
    }

    // ==== ãƒ©ãƒ³ã‚¯æ±ºå®šã®è¿½åŠ ãƒ«ãƒ¼ãƒ« ====
    // é€±æ¬¡ãƒ—ãƒªã‚»ãƒƒãƒˆã® 08:00-11:59 ã¨ 20:00-23:59 ã¯ S
    const SPECIAL_WEEKLY_S_RANGES = [ ['08:00','11:59'], ['20:00','23:59'] ];
    function isInSpecialSRange(start,end){
      return SPECIAL_WEEKLY_S_RANGES.some(([s,e])=>s===start && e===end);
    }
    // æ›œæ—¥åˆ¥ã®çµ‚æ—¥ã‚¿ã‚¹ã‚¯ï¼ˆALLDAY_PRESETï¼‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’ A ã®æ—¢å®šã«ã™ã‚‹ãŸã‚ã®åˆ¤å®š
    function isWeekdayAllDayTitle(title){
      for(const k of Object.keys(ALLDAY_PRESET)){
        if((ALLDAY_PRESET[k]||[]).includes(title)) return true;
      }
      return false;
    }
    function getRankForTask(t){
      // 1) ã‚¿ã‚°å„ªå…ˆ
      const tagged = parseRankFromTitle(t.title);
      if(tagged) return tagged;
      // 2) é€±æ¬¡ç‰¹åˆ¥æ  â†’ S
      if(isInSpecialSRange(t.start,t.end)) return 'S';
      // 3) æ›œæ—¥åˆ¥ã®çµ‚æ—¥ã‚¿ã‚¹ã‚¯
      if(t.allDay && isWeekdayAllDayTitle(t.title)){
        // ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰ ã‚’å«ã‚€ã‚‚ã®ã¯ S ã§ä¸Šæ›¸ã
        if(/(19æ™‚|ç¿Œæœ7æ™‚)/.test(t.title)) return 'S';
        return 'A';
      }
      // 4) å›ºå®šãƒãƒƒãƒ— or æ—¢å®š
      return RANK_BY_TITLE[t.title] || DEFAULT_RANK;
    }

    // === å‡¶æš´é¦–é ˜ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ›œæ—¥Ã—4æ ï¼‰ ===
    const BOSS_SLOTS = [ ['00:00','02:59'], ['06:00','08:59'], ['12:00','14:59'], ['18:00','20:59'] ];
    function pushBoss(list, w, dateStr){
      const push = (name)=>{
        for(const [s,e] of BOSS_SLOTS){
          list.push({ id: Math.random().toString(36).slice(2), title: name, date: dateStr, allDay:false, start:s, end:e, completed:false });
        }
      };
      if(w===1 || w===4) push('å‡¶æš´é¦–é ˜ï¼ˆè¡€ã®ãƒãƒ©ï¼‰');
      if(w===2 || w===5) push('å‡¶æš´é¦–é ˜ï¼ˆæšã®ç¿¼ï¼‰');
      if(w===3 || w===6) push('å‡¶æš´é¦–é ˜ï¼ˆè‡ªç”±æ„å¿—ï¼‰');
    }

    function ensurePresetForToday(){
      const today = apNow();
      const todayStr = fmtDate(today);
      if(localStorage.getItem(PRESET_KEY) === todayStr) return;

      // ä»Šæ—¥ã®åˆ†ã‚’ä¸€æ—¦å‰Šé™¤
      tasks = (tasks||[]).filter(t=>t.date!==todayStr);
      const w = today.getDay();

      // æ™‚é–“æ  6æœ¬æŠ•å…¥ï¼ˆAPåŸºæº–ï¼‰
      for(const [start,end,title] of (WEEKLY_PRESET[w]||[])){
        tasks.push({ id:Math.random().toString(36).slice(2), title, date:todayStr, allDay:false, start, end, completed:false });
      }
      // çµ‚æ—¥æŠ•å…¥ï¼ˆæ›œæ—¥åˆ¥ï¼‰
      for(const ttl of (ALLDAY_PRESET[w]||[])){
        tasks.push({ id:Math.random().toString(36).slice(2), title:ttl, date:todayStr, allDay:true, start:'00:00', end:'23:59', completed:false });
      }
      // å³¡è°·äº‰å¥ªæˆ¦ï¼ˆå‡ºæ¬ ç¢ºèªï¼‰
      if (w === 3) {
        tasks.push({ id: Math.random().toString(36).slice(2), title:'å³¡è°·äº‰å¥ªæˆ¦ï¼ˆå‡ºæ¬ ç¢ºèªï¼‰', date: todayStr, allDay:true, start:'00:00', end:'23:59', completed:false });
      }
      // åœŸæ›œã¯ã‚­ãƒ«ãƒ‡ãƒ¼ï¼ˆçµ‚æ—¥ï¼‰
      if (w === 6) {
        tasks.push({ id: Math.random().toString(36).slice(2), title:'æ•µè»æ’ƒç ´ï¼ˆã‚­ãƒ«ãƒ‡ãƒ¼ï¼‰', date: todayStr, allDay:true, start:'00:00', end:'23:59', completed:false });
      }
      // æ—¥æ›œã¯è©¦ç·´ã‚¾ãƒ³ãƒ“ï¼ˆçµ‚æ—¥ï¼‰
      if (w === 0) {
        tasks.push({ id: Math.random().toString(36).slice(2), title:'è©¦ç·´ã‚¾ãƒ³ãƒ“', date: todayStr, allDay:true, start:'00:00', end:'23:59', completed:false });
      }
      // å…±é€šçµ‚æ—¥ã‚¿ã‚¹ã‚¯ï¼ˆæ¯æ—¥ï¼‰
      for(const ttl of DAILY_COMMON){
        tasks.push({ id:Math.random().toString(36).slice(2), title:ttl, date:todayStr, allDay:true, start:'00:00', end:'23:59', completed:false });
      }

      // ç„¡æ–™ç‡ƒæ–™100ã®å—ã‘å–ã‚Šï¼ˆæ™‚é–“å¸¯ã‚¿ã‚¹ã‚¯ï¼š08:00-19:59 / 20:00-ç¿Œ07:59ï¼‰
      tasks.push({ id: Math.random().toString(36).slice(2), title:'ç„¡æ–™ç‡ƒæ–™ã‚’100å—ã‘å–ã‚‹', date: todayStr, allDay:false, start:'08:00', end:'19:59', completed:false });
      tasks.push({ id: Math.random().toString(36).slice(2), title:'ç„¡æ–™ç‡ƒæ–™ã‚’100å—ã‘å–ã‚‹', date: todayStr, allDay:false, start:'20:00', end:'07:59', completed:false });

      // å‡¶æš´é¦–é ˜ï¼ˆæ›œæ—¥åˆ¥ï¼‰
      pushBoss(tasks, w, todayStr);

      // === æ¯é€±é‡‘æ›œã®ã€Œå³¡è°·äº‰å¥ªæˆ¦ã€ï¼ˆAP 09:00ã€œ09:40ï¼‰ ===
      if (w === 5) {
        tasks.push({ id: Math.random().toString(36).slice(2), title:'å³¡è°·äº‰å¥ªæˆ¦', date: todayStr, allDay:false, start:'09:00', end:'09:40', completed:false });
      }

      // === æ¯é€±é‡‘æ›œã®ã€Œå³¡è°·äº‰å¥ªæˆ¦æº–å‚™ã€ï¼ˆAP 09:00ã€œ09:40ï¼‰ ===
      if (w === 5) {
        tasks.push({ id: Math.random().toString(36).slice(2), title:'å³¡è°·äº‰å¥ªæˆ¦ï¼ˆæº–å‚™ï¼‰', date: todayStr, allDay:false, start:'08:30', end:'08:59', completed:false });
      }

      // === 3æ—¥ãŠãã®ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆB777 & C777ï¼‰ ===
      let baseDay = Number(localStorage.getItem(ZOMBIE_BASE_KEY));
      const todayDay = apDayIndex(todayStr);
      if(!Number.isFinite(baseDay)) { baseDay = todayDay; localStorage.setItem(ZOMBIE_BASE_KEY, String(baseDay)); }
      if (((todayDay - baseDay) % 3 + 3) % 3 === 0) {
        tasks.push({ id: Math.random().toString(36).slice(2), title:'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆæº–å‚™ï¼‰', date: todayStr, allDay:false, start:'09:30', end:'09:59', completed:false });
        tasks.push({ id: Math.random().toString(36).slice(2), title:'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›', date: todayStr, allDay:false, start:'10:00', end:'10:15', completed:false });
        tasks.push({ id: Math.random().toString(36).slice(2), title:'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆæº–å‚™ï¼‰', date: todayStr, allDay:false, start:'10:30', end:'10:59', completed:false });
        tasks.push({ id: Math.random().toString(36).slice(2), title:'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›', date: todayStr, allDay:false, start:'11:00', end:'11:15', completed:false });
      }

      localStorage.setItem(PRESET_KEY, todayStr);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
    }

    function classify(t, now){
      if(t.completed) return 'done';
      if(t.allDay) return 'today';
      const {s,e} = getStartEnd(t);
      if(e <= now) return 'done';
      if(s <= now && now < e) return 'now';
      if(s >  now && fmtDate(s)===fmtDate(now)) return 'upcoming';
      return null;
    }

    function createRankBadge(rank){
      const r = document.createElement('span');
      r.className = 'rank-badge';
      r.textContent = rank;
      r.title = `ãƒ©ãƒ³ã‚¯: ${rank}`;
      return r;
    }

    function decorateItemWithRank(el, rank){
      el.classList.add(`rank-${rank}`);
    }

    function buildSubsHtml(details){
      if(!details || !details.length) return '';
      const items = details.map(text=>{
        const icon = SUB_ICON_BY_TEXT[text];
        const iconHtml = icon ? `<span class="sub-icon">${icon}</span>` : '';
        return `<li>${iconHtml}${text}</li>`;
      }).join('');
      return `<ul class="subs">${items}</ul>`;
    }

    function itemTemplate(t, key){
      const wrap = document.createElement('div');
      const rank = getRankForTask(t);
      wrap.className = 'item clickable' + (key==='now'?' now': key==='upcoming'?' future':'');
      decorateItemWithRank(wrap, rank);

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = !!t.completed;
      checkbox.onchange = ()=>{ t.completed = checkbox.checked; localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); draw(); };

      const main  = document.createElement('div');
      const name  = document.createElement('div');
      const iconNode = createIconNodeForTask(t);
      if(iconNode) name.append(iconNode);
      name.append(document.createTextNode(stripRankTag(t.title)));
      const meta  = document.createElement('div'); meta.className='muted';

      const rankWrap = document.createElement('div');
      rankWrap.append(createRankBadge(rank));

      const details = SUBTASKS[t.title] || [];

      if(t.allDay){
        const subsHtml = buildSubsHtml(details);
        meta.innerHTML = `<span class="jp">çµ‚æ—¥</span>${subsHtml}`;
      }else{
        const {s,e} = getStartEnd(t);
        const jpS = new Date(s.getTime() - OFFSET_HOURS*3600*1000);
        const jpE = new Date(e.getTime() - OFFSET_HOURS*3600*1000);
        const subsHtml = buildSubsHtml(details);
        meta.innerHTML = `<span class="jp" style="font-size:14px;">æ—¥æœ¬æ™‚é–“ ${fmtTime(jpS)}ã€œ${fmtTime(jpE)}</span>${subsHtml}`;
      }

      main.append(name, meta);
      wrap.append(checkbox, main, rankWrap);

      // ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚§ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹/ãƒªãƒ³ã‚¯ã‚’ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã¯é™¤å¤–ï¼‰
      wrap.addEventListener('click', (ev)=>{
        if (ev.target === checkbox || ev.target.closest('a')) return;
        checkbox.checked = !checkbox.checked;
        t.completed = checkbox.checked;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        draw();
      });
      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼ˆEnter/Spaceï¼‰
      wrap.tabIndex = 0;
      wrap.addEventListener('keydown', (ev)=>{
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          checkbox.checked = !checkbox.checked;
          t.completed = checkbox.checked;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
          draw();
        }
      });

      return wrap;
    }

    function itemTemplateReadOnly(t){
      const wrap = document.createElement('div');
      const rank = getRankForTask(t);
      wrap.className = 'item ro';
      decorateItemWithRank(wrap, rank);

      const main  = document.createElement('div');
      const name  = document.createElement('div');
      const iconNode = createIconNodeForTask(t);
      if(iconNode) name.append(iconNode);
      name.append(document.createTextNode(stripRankTag(t.title)));
      const meta  = document.createElement('div'); meta.className='muted';

      const rankWrap = document.createElement('div');
      rankWrap.append(createRankBadge(rank));

      const details = SUBTASKS[t.title] || [];

      if(t.allDay){
        const subsHtml = buildSubsHtml(details);
        meta.innerHTML = `<span class="jp">çµ‚æ—¥</span>${subsHtml}`;
      }else{
        const {s,e} = getStartEnd(t);
        const jpS = new Date(s.getTime() - OFFSET_HOURS*3600*1000);
        const jpE = new Date(e.getTime() - OFFSET_HOURS*3600*1000);
        const subsHtml = buildSubsHtml(details);
        meta.innerHTML = `<span class="jp" style="font-size:14px;">æ—¥æœ¬æ™‚é–“ ${fmtTime(jpS)}ã€œ${fmtTime(jpE)}</span>${subsHtml}`;
      }

      main.append(name, meta);
      wrap.append(main, rankWrap);
      return wrap;
    }

    function buildPresetFor(dateObj){
      const dateStr = fmtDate(dateObj);
      const w = dateObj.getDay();
      const preview = [];
      for(const [start,end,title] of (WEEKLY_PRESET[w]||[])){
        preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title, date:dateStr, allDay:false, start, end, completed:false });
      }
      for(const ttl of (ALLDAY_PRESET[w]||[])){
        preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title:ttl, date:dateStr, allDay:true, start:'00:00', end:'23:59', completed:false });
      }
      for(const ttl of DAILY_COMMON){
        preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title:ttl, date:dateStr, allDay:true, start:'00:00', end:'23:59', completed:false });
      }
      // ç„¡æ–™ç‡ƒæ–™100ã®å—ã‘å–ã‚Šï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼š08:00-19:59 / 20:00-ç¿Œ07:59ï¼‰
      preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title:'ç„¡æ–™ç‡ƒæ–™ã‚’100å—ã‘å–ã‚‹', date: dateStr, allDay:false, start:'08:00', end:'19:59', completed:false });
      preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title:'ç„¡æ–™ç‡ƒæ–™ã‚’100å—ã‘å–ã‚‹', date: dateStr, allDay:false, start:'20:00', end:'07:59', completed:false });

      // å‡¶æš´é¦–é ˜ï¼ˆæ›œæ—¥åˆ¥ï¼‰
      pushBoss(preview, w, dateStr);

      if (w === 5) {
        preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title:'å³¡è°·äº‰å¥ªæˆ¦', date: dateStr, allDay:false, start:'09:00', end:'09:40', completed:false });
      }
      if (w === 5) {
        preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title:'å³¡è°·äº‰å¥ªæˆ¦ï¼ˆæº–å‚™ï¼‰', date: dateStr, allDay:false, start:'08:30', end:'08:59', completed:false });
      }
      let baseDay = Number(localStorage.getItem(ZOMBIE_BASE_KEY));
      const tday = apDayIndex(dateStr);
      if(!Number.isFinite(baseDay)) baseDay = tday;
      if (((tday - baseDay) % 3 + 3) % 3 === 0) {
        preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title:'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆæº–å‚™ï¼‰', date: dateStr, allDay:false, start:'09:30', end:'09:59', completed:false });
        preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title:'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›', date: dateStr, allDay:false, start:'10:00', end:'10:15', completed:false });
        preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title:'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›ï¼ˆæº–å‚™ï¼‰', date: dateStr, allDay:false, start:'10:30', end:'10:59', completed:false });
        preview.push({ id: 'prev_'+Math.random().toString(36).slice(2), title:'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›', date: dateStr, allDay:false, start:'11:00', end:'11:15', completed:false });
      }
      return preview;
    }

    function draw(){
      const now = apNow();
      const todayStr = fmtDate(now);
      const jpNow = new Date(now.getTime() - OFFSET_HOURS*3600*1000);
      const clk = document.getElementById('clock');
      if(clk) clk.textContent = `æ—¥æœ¬æ™‚é–“ ${fmtDate(jpNow)} ${fmtTime(jpNow)} ï¼ çµ‚æœ«æ™‚é–“ ${fmtDate(now)} ${fmtTime(now)}`;

      const todays = (tasks||[]).filter(t=>t.date===todayStr);
      const buckets = { now:[], today:[], upcoming:[], done:[] };
      for(const t of todays){ const k = classify(t, now); if(k) buckets[k].push(t); }

      for(const k of Object.keys(buckets)){
        const list = document.getElementById(`${k}-list`); if(!list) continue; list.innerHTML='';
        buckets[k].sort((a,b)=> (a.start||'00:00').localeCompare(b.start||'00:00'));
        for(const t of buckets[k]) list.append(itemTemplate(t,k));
        const badge=document.getElementById(`${k}-count`); if(badge) badge.textContent=String(buckets[k].length);
      }

      // æ˜æ—¥ã®äºˆå®šï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šãƒã‚§ãƒƒã‚¯ãªã—ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœªä¿å­˜ï¼‰
      const tomorrow = new Date(now.getTime()+86400000);
      const pv = buildPresetFor(tomorrow);
      pv.sort((a,b)=> (a.allDay===b.allDay ? (a.start||'00:00').localeCompare(b.start||'00:00') : (a.allDay?1:-1)));
      const tlist = document.getElementById('tomorrow-list');
      if(tlist){ tlist.innerHTML=''; pv.forEach(t=> tlist.append(itemTemplateReadOnly(t))); }
      const tbadge = document.getElementById('tomorrow-count'); if(tbadge) tbadge.textContent = String(pv.length);
    }

    // ==== èµ·å‹•å‡¦ç†ï¼ˆä¿å­˜ç‰ˆä»•æ§˜ï¼šã‚¹ã‚¿ãƒ³ãƒ—å‰Šé™¤â†’å½“æ—¥å†æŠ•å…¥ï¼‰ ====
    try{ localStorage.removeItem(PRESET_KEY); }catch(e){}
    ensurePresetForToday();
    draw();
    setInterval(draw, 30*1000);

    // æ‰‹å‹•å†æŠ•å…¥
    (function(){ const btn=document.getElementById('reloadBtn'); if(!btn) return; btn.addEventListener('click',()=>{ try{localStorage.removeItem(PRESET_KEY);}catch(e){} ensurePresetForToday(); draw(); }); })();

    // ==== ç°¡æ˜“ã‚»ãƒ«ãƒ•ãƒ†ã‚¹ãƒˆï¼ˆDOM/ãƒ‘ãƒ¼ã‚¹/ãƒ©ãƒ³ã‚¯/ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ ====
    (function(){
      try{
        console.assert(document.querySelector('.container') && document.getElementById('tomorrow-list'), 'DOM base elements exist');
        console.assert(isWeekdayAllDayTitle('å»ºç¯‰åŠ é€Ÿã‚’æ¶ˆè²»ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰')===true, 'weekday all-day title detection');
        // rank parse tests (æ—¢å­˜)
        console.assert(parseRankFromTitle('ã€Sã€‘å³¡è°·äº‰å¥ªæˆ¦')==='S', 'rank tag fullwidth');
        console.assert(parseRankFromTitle('[A] B777ã€€ã‚¾ãƒ³ãƒ“æš´å›')==='A', 'rank tag ascii');
        console.assert(stripRankTag('ã€Sã€‘å³¡è°·äº‰å¥ªæˆ¦')==='å³¡è°·äº‰å¥ªæˆ¦', 'strip works');
        // è¿½åŠ ãƒ†ã‚¹ãƒˆ: é€±æ¬¡Så¸¯
        (function(){
          const t={title:'æ”¹é€ è»Šå¼·åŒ–', allDay:false, start:'08:00', end:'11:59'}; console.assert(getRankForTask(t)==='S','weekly special AM is S');
          const u={title:'æ”¹é€ è»Šå¼·åŒ–', allDay:false, start:'20:00', end:'23:59'}; console.assert(getRankForTask(u)==='S','weekly special PM is S');
        })();
        // è¿½åŠ ãƒ†ã‚¹ãƒˆ: æ›œæ—¥çµ‚æ—¥(A) ã¨ ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰ å«ã‚€(S)
        (function(){
          const tA='ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å—é ˜'; console.assert(isWeekdayAllDayTitle(tA), 'weekday title detected');
          const tS='å»ºç¯‰ã‚’å®Œäº†ï¼ˆ19æ™‚ã€ç¿Œæœ7æ™‚ï¼‰'; console.assert(isWeekdayAllDayTitle(tS), 'weekday title detected 2');
          const ta={title:tA, allDay:true, start:'00:00', end:'23:59'}; console.assert(getRankForTask(ta)==='A','weekday all-day default A');
          const ts={title:tS, allDay:true, start:'00:00', end:'23:59'}; console.assert(getRankForTask(ts)==='S','weekday all-day with (19/7) is S');
        })();
        // è¿½åŠ ãƒ†ã‚¹ãƒˆ: æš´å›S ã¨ SUBTASKS ã®ã‚­ãƒ¼å­˜åœ¨
        (function(){
          const b={title:'B777ã€€ã‚¾ãƒ³ãƒ“æš´å›', allDay:false, start:'10:00', end:'10:15'}; console.assert(getRankForTask(b)==='S','B777 tyrant S');
          const c={title:'C777ã€€ã‚¾ãƒ³ãƒ“æš´å›', allDay:false, start:'11:00', end:'11:15'}; console.assert(getRankForTask(c)==='S','C777 tyrant S');
          console.assert(Array.isArray(SUBTASKS['B777ã€€ã‚¾ãƒ³ãƒ“æš´å›']) && Array.isArray(SUBTASKS['C777ã€€ã‚¾ãƒ³ãƒ“æš´å›']), 'SUBTASKS entries for tyrants exist');
          console.assert(Array.isArray(SUBTASKS['é»„è‰²ã„ãƒãƒ©ã‚’è´ˆã‚‹']), 'SUBTASKS entry for all-day daily title exists');
        })();
        // è¿½åŠ ãƒ†ã‚¹ãƒˆ: ç„¡æ–™ç‡ƒæ–™ 2 æœ¬ï¼ˆæ™‚é–“å¸¯ï¼‰
        (function(){
          const prev = buildPresetFor(apNow());
          const cnt = prev.filter(x=>x.title==='ç„¡æ–™ç‡ƒæ–™ã‚’100å—ã‘å–ã‚‹').length;
          console.assert(cnt===2, 'two free-fuel windows exist');
        })();
        // è¿½åŠ ãƒ†ã‚¹ãƒˆ: ã‚µãƒ–ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©ãŒåŠ¹ãã‹
        (function(){
          console.assert(SUB_ICON_BY_TEXT['å»ºç¯‰æˆ¦åŠ›ã‚’ä¸Šã’ã‚‹']==='ğŸ—ï¸', 'sub icon mapping exists');
        })();
      }catch(e){ console.warn('SelfTest warning:', e); }
    })();
  </script>
</body>
</html>
